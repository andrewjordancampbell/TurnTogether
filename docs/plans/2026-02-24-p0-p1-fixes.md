# TurnTogether P0/P1/P2 Fix Plan

**Goal:** Fix all broken functionality, wire up the core user loop, and bring the app to launchable quality.

**Core loop that must work end-to-end:** Sign up → Create club → Search & set book → Invite/join club → Track progress → Discuss chapters → Reading room

**Run tests after every fix:** `npm run test:run && npm run build`

---

## P0 — Showstoppers (app is broken without these)

### Fix 1: RLS policy blocks club admin creation

**Problem:** `002_rls_policies.sql` line 55 restricts club_members INSERT to `role = 'member'` only. The `createClub` action in `src/app/clubs/new/actions.ts` inserts with `role: 'admin'`, which gets silently rejected by RLS. No club ever has an admin.

**Fix:** Create migration `supabase/migrations/003_fix_rls_admin.sql`:
```sql
drop policy "Users can join clubs" on club_members;

create policy "Users can join clubs as members"
  on club_members for insert to authenticated
  with check (user_id = (select auth.uid()) and role = 'member');

create policy "Club creators can set admin role"
  on club_members for insert to authenticated
  with check (
    user_id = (select auth.uid())
    and role = 'admin'
    and exists (
      select 1 from clubs
      where clubs.id = club_members.club_id
        and clubs.created_by = (select auth.uid())
    )
  );
```

Also wrap the club creation + admin insert in `src/app/clubs/new/actions.ts` so if the admin insert fails, the club is deleted (or use a Supabase RPC transaction).

### Fix 2: No "Join Club" button or action

**Problem:** Discover page and club pages show clubs but there's no way to join one.

**Fix:**
- Create `src/app/clubs/[id]/join/actions.ts` with a `joinClub` server action that inserts into `club_members` with `role: 'member'`
- Add a "Join Club" button on the club detail page (`src/app/clubs/[id]/page.tsx`) that only shows if the current user is NOT already a member
- Add a "Join" button on each club card in the discover page (`src/app/discover/page.tsx`)
- Handle already-a-member case gracefully

### Fix 3: No way to set a book for a club

**Problem:** `BookSearch` component exists but is never wired to save a book to a club. `clubs.current_book_id` is never set.

**Fix:**
- Create `src/app/clubs/[id]/set-book/actions.ts` — server action that:
  1. Upserts the book into the `books` table (using Open Library data)
  2. Updates `clubs.current_book_id` to point to that book
  3. Only allows club admins to do this
- Create `src/app/clubs/[id]/set-book/page.tsx` — page that renders `BookSearch` with an `onSelect` handler wired to the server action
- Add "Set Current Book" link on the club page (visible to admins only)

### Fix 4: ProgressUpdater never rendered

**Problem:** `src/components/progress-updater.tsx` exists but is never imported anywhere.

**Fix:**
- Render `ProgressUpdater` on the club detail page (`src/app/clubs/[id]/page.tsx`) when the club has a current book and the user is a member
- Make sure it passes the correct `clubId`, `bookId`, and existing progress values
- The `clubId` prop should be a `number` — fix the type mismatch since URL params are strings

### Fix 5: Auth error messages never displayed

**Problem:** Login and signup actions return `{ error: string }` but the pages never read or display it.

**Fix:**
- Convert login and signup pages to use `useFormState` (or `useActionState` in React 19) to capture the returned error
- Display the error message above the form in a red alert box
- Also handle the `?error=auth` query param from the OAuth callback redirect

### Fix 6: Server actions throw errors instead of returning them

**Problem:** `createClub`, `createDiscussion`, `addComment`, and `updateProgress` all do `throw new Error(error.message)` which crashes the page with an unhandled error.

**Fix:** Change all `throw new Error()` calls to `return { error: error.message }` and handle the error in the UI with `useFormState` / `useActionState`.

---

## P1 — Serious Issues

### Fix 7: Reading Room sendMessage uses wrong channel reference

**Problem:** `sendMessage` in `src/components/reading-room.tsx` calls `supabase.channel(...)` which creates a NEW unsubscribed channel instead of reusing the one from `useEffect`.

**Fix:** Store the channel in a `useRef<RealtimeChannel | null>(null)` and use `channelRef.current.send()` in `sendMessage`.

### Fix 8: Dark mode broken

**Problem:** All components use hardcoded light colors (`bg-white`, `text-gray-600`, `hover:bg-gray-50`, etc.). In dark mode, cards are unreadable.

**Fix:** Either:
- (Simpler) Disable dark mode in `tailwind.config.ts` by setting `darkMode: 'class'` and not adding the class — forces light mode
- (Better) Add dark mode variants to all components: `bg-white dark:bg-gray-900`, `text-gray-600 dark:text-gray-400`, `border dark:border-gray-700`, etc.

Recommend the simpler approach for now — force light mode. Dark mode can be a post-launch feature.

### Fix 9: Generate Supabase TypeScript types

**Fix:**
- Run `npx supabase gen types typescript --linked > src/lib/supabase/database.types.ts`
- Update `src/lib/supabase/client.ts` and `server.ts` to use `Database` generic: `createBrowserClient<Database>(...)`
- Remove all `any` casts and inline type annotations from page files
- Add a script to `package.json`: `"db:types": "supabase gen types typescript --linked > src/lib/supabase/database.types.ts"`

### Fix 10: Add Zod validation to all server actions

**Fix:**
- `npm install zod`
- Create validation schemas for each action (createClub, joinClub, createDiscussion, addComment, updateProgress, login, signup)
- Validate `formData` at the top of every server action before touching the database
- Return typed error messages for validation failures

### Fix 11: Move book search to a server action (CORS fix)

**Problem:** `BookSearch` component calls Open Library directly from the browser, which may fail with CORS.

**Fix:**
- Create `src/app/books/search/actions.ts` with a `searchBooksAction` server action that calls `searchBooks()` on the server
- Update `BookSearch` component to call the server action instead of the raw function

### Fix 12: Add error boundaries

**Fix:**
- Create `src/app/error.tsx` — root error boundary with "Something went wrong" message and retry button
- Create `src/app/not-found.tsx` — custom 404 page
- Create `src/app/clubs/[id]/error.tsx` — club-specific error boundary

---

## P2 — Missing for Launch

### Fix 13: Add loading states

**Fix:** Create `loading.tsx` files with skeleton UI for:
- `src/app/dashboard/loading.tsx`
- `src/app/clubs/[id]/loading.tsx`
- `src/app/discover/loading.tsx`
- `src/app/books/search/loading.tsx`

### Fix 14: Mobile responsive navigation

**Fix:** Replace the horizontal nav links in `src/components/nav.tsx` with a hamburger menu on mobile using Tailwind responsive classes. Show full nav on `md:` breakpoint and up.

### Fix 15: Add invite link flow

**Fix:**
- Create `src/app/invite/[code]/page.tsx` — looks up club by `invite_code`, shows club info, and offers a "Join" button
- Add "Copy Invite Link" button on club settings (generates URL like `/invite/{invite_code}`)

### Fix 16: Password reset flow

**Fix:**
- Create `src/app/forgot-password/page.tsx` with email input
- Create `src/app/forgot-password/actions.ts` that calls `supabase.auth.resetPasswordForEmail()`
- Create `src/app/reset-password/page.tsx` to handle the reset callback
- Add "Forgot password?" link to login page

### Fix 17: Profile editing

**Fix:**
- Add an "Edit Profile" button on `src/app/profile/page.tsx`
- Create `src/app/profile/edit/page.tsx` with form for display_name, bio
- Create `src/app/profile/edit/actions.ts` with update server action

### Fix 18: Add timestamps to discussions and comments

**Fix:** Add relative timestamps (e.g., "2 hours ago") to discussion list items and individual comments. Use a lightweight formatter — create a `src/lib/utils/time.ts` with a `timeAgo()` function or use `date-fns/formatDistanceToNow`.

### Fix 19: Pagination on discover and discussions

**Fix:** Add cursor-based or offset pagination to:
- Discover page (already limited to 20, add "Load more")
- Discussions list
- Comments in discussion detail

### Fix 20: Parallel query fetching

**Fix:** In `src/app/profile/page.tsx` and `src/app/clubs/[id]/page.tsx`, wrap sequential Supabase queries in `Promise.all()` for parallel execution.

### Fix 21: Add chapters management UI

**Fix:**
- Create `src/app/clubs/[id]/chapters/page.tsx` for managing chapters
- Create server actions for adding/editing/deleting chapters
- Link discussions to chapters
- This enables the spoiler-gating feature described in the design doc

---

## Verification Checklist

After all fixes, the following flows must work end-to-end:

1. [ ] Sign up with email → lands on dashboard
2. [ ] Log in with email → lands on dashboard
3. [ ] Create a club (public) → redirected to club page, user is admin
4. [ ] Search for a book → results appear
5. [ ] Set a book for the club → book appears on club page
6. [ ] Another user discovers the club → can join
7. [ ] Both users update reading progress → progress bars update
8. [ ] User creates a discussion → appears in list
9. [ ] Other user comments → comment appears
10. [ ] Users enter reading room → see each other, can chat
11. [ ] User views profile → stats are correct
12. [ ] Invite link works → new user can join private club
13. [ ] All forms show errors on failure
14. [ ] Mobile nav works
15. [ ] `npm run test:run` passes
16. [ ] `npm run build` succeeds with no errors
